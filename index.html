<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jessie Math - 影子配對所</title>

  <!-- ✅ 快取連結預覽（請放在 <head> 裡） -->
  <meta name="description" content="© 2025–2026 Jessie Math 捷析老師. All rights reserved." />
  <!-- ✅ LINE / FB 預覽用 -->
  <meta property="og:title" content="Jessie Math - 影子配對所" />
  <meta property="og:description" content="© 2025–2026 Jessie Math 捷析老師. All rights reserved." />
  <meta property="og:type" content="website" />

  <!-- ✅ 預覽圖片-->
  <meta property="og:image" content="g4-u7-2.png" />
  <meta property="og:image:width" content="1024" />
  <meta property="og:image:height" content="1536" />
  <meta property="og:image:alt" content="Jessie Math 遊戲封面" />

  <!-- ✅ 有些平台會參考 -->
  <link rel="image_src" href="g4-u7-2.png" />

  <!-- ✅ Twitter / X（可用同一張圖） -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Jessie Math - 影子配對所" />
  <meta name="twitter:description" content="© 2025–2026 Jessie Math 捷析老師. All rights reserved." />
  <meta name="twitter:image" content="g4-u7-2.png" />

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg-dark:#fbf6ea;
      --bg-canvas:#f3ead3;
      --glass-bg:rgba(255,255,255,.55);
      --glass-border:rgba(15,23,42,.14);
      --text-main:#0f172a;
      --text-dim:#475569;
      --accent-blue:#38bdf8;
      --accent-amber:#f59e0b;
      --accent-purple:#818cf8;
      --error:#f43f5e;
      --success:#10b981;
      --radius-lg:24px;
      --radius-md:16px;
      --font-family:"Inter","Noto Sans TC",system-ui,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family:var(--font-family);
      background-color:var(--bg-dark);
      background-image:
        radial-gradient(circle at 20% 20%, rgba(245,158,11,.10) 0%, transparent 42%),
        radial-gradient(circle at 80% 80%, rgba(56,189,248,.10) 0%, transparent 42%);
      color:var(--text-main);
      overflow-x:hidden;
    }

    /* HERO */
    .hero{
      position:sticky;top:0;z-index:100;
      background:rgba(251,246,234,.88);
      backdrop-filter:blur(12px);
      border-bottom:1px solid var(--glass-border);
    }
    .hero-inner{
      width:min(1200px,94vw);
      margin:0 auto;
      padding:12px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{display:flex;align-items:center;gap:14px}
    .brand-badge{
      width:42px;height:42px;border-radius:50%;
      border:2px solid var(--accent-amber);
      padding:2px;background:rgba(245,158,11,.12);
      display:grid;place-items:center;
      overflow:hidden;
    }
    .brand-badge img{width:100%;height:100%;object-fit:contain}
    .brand-title{
      font-size:24px;font-weight:700;letter-spacing:-.5px;
      background:linear-gradient(to right,#0f172a,#64748b);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      white-space:nowrap;
    }
    .nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      text-decoration:none;color:var(--text-dim);
      font-size:14px;font-weight:600;
      padding:8px 16px;border-radius:999px;
      background:rgba(255,255,255,.55);
      border:1px solid var(--glass-border);
      transition:all .2s ease;
      display:flex;align-items:center;gap:8px;
    }
    .pill:hover{color:var(--text-main);background:rgba(255,255,255,.75);transform:translateY(-1px)}
    .pill.accent{border-color:rgba(245,158,11,.55);color:#b45309}

    /* LAYOUT */
    .wrap{width:min(1200px,94vw);margin:32px auto}
    .page{display:none;animation:slideUp .35s cubic-bezier(.16,1,.3,1)}
    .page.active{display:block}
    @keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

    /* CARDS */
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      backdrop-filter:blur(4px);
      border-radius:var(--radius-lg);
      padding:32px;
      box-shadow:0 20px 40px rgba(15,23,42,.12);
    }
    .h1{font-size:28px;font-weight:800;margin:0 0 12px}
    .sub{color:var(--text-dim);line-height:1.6;margin:0 0 24px;font-size:16px}

    .input-group{display:flex;gap:12px;margin-bottom:22px;flex-wrap:wrap}
    .input{
      flex:1;min-width:200px;
      background:rgba(255,255,255,.65);
      border:1px solid var(--glass-border);
      border-radius:var(--radius-md);
      padding:14px 20px;
      display:flex;align-items:center;gap:12px;
      color:var(--text-dim);
    }
    .input input{
      background:transparent;border:none;outline:none;
      color:var(--text-main);font-size:16px;width:100%;
    }
    .select{
      display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,.65);
      border:1px solid var(--glass-border);
      border-radius:var(--radius-md);
      padding:12px 14px;
      min-width:210px;
      color:var(--text-dim);
    }
    .select select{
      width:100%;
      background:transparent;border:none;outline:none;
      font-size:15px;color:var(--text-main);
      cursor:pointer;appearance:none;
    }

    .btn{
      cursor:pointer;border:none;border-radius:var(--radius-md);
      padding:14px 28px;font-weight:700;font-size:16px;
      display:inline-flex;align-items:center;gap:10px;
      transition:all .2s ease;
      user-select:none;
    }
    .btn.primary{background:var(--accent-blue);color:#06202a}
    .btn.primary:hover{transform:scale(1.02);filter:brightness(1.05)}
    .btn.ghost{
      background:rgba(255,255,255,.55);color:var(--text-dim);
      border:1px solid var(--glass-border);
    }
    .btn.ghost:hover{background:rgba(255,255,255,.75);color:var(--text-main)}

    .rules{display:grid;gap:12px;margin-top:10px}
    .rule{
      background:rgba(255,255,255,.55);
      padding:16px;border-radius:var(--radius-md);
      border-left:3px solid var(--accent-purple);
      font-size:15px;color:var(--text-dim);
    }
    .rule b{color:var(--text-main)}
    .rule ul{margin:10px 0 0 18px;padding:0;line-height:1.75}
    .rule li{margin:2px 0}

    table{width:100%;border-collapse:collapse;margin-top:16px}
    th{
      text-align:left;color:var(--text-dim);
      font-size:12px;padding:12px;border-bottom:1px solid var(--glass-border);
    }
    td{
      padding:14px 12px;border-bottom:1px solid rgba(15,23,42,.08);
      font-weight:500;color:var(--text-main);
    }
    .rank{color:#b45309;font-family:monospace}
    .score{text-align:right;color:#0284c7}

    /* GAME */
    .game-shell{
      background:var(--bg-canvas);
      border-radius:var(--radius-lg);
      border:1px solid var(--glass-border);
      overflow:hidden;
      box-shadow:0 40px 80px rgba(15,23,42,.18);
    }
    .hud{
      padding:20px 24px;
      background:rgba(255,255,255,.55);
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      border-bottom:1px solid var(--glass-border);
      flex-wrap:wrap;
    }
    .chip{
      background:rgba(255,255,255,.6);
      padding:8px 16px;border-radius:99px;
      font-size:13px;font-weight:700;color:var(--text-dim);
      border:1px solid var(--glass-border);
      white-space:nowrap;
    }
    .chip span{color:var(--text-main);margin-left:4px}

    .arena{
      height:65vh;min-height:520px;
      position:relative;overflow:hidden;
      background:radial-gradient(circle at 50% 50%, rgba(56,189,248,.10) 0%, transparent 70%);
      width:100%;
      touch-action:none;
    }

    .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)}
    .shadow-slot{
      width:260px;height:260px;border-radius:40px;
      background:rgba(255,255,255,.55);
      border:2px dashed rgba(15,23,42,.18);
      display:grid;place-items:center;
      position:relative;
    }
    .shadow-label{display:none}
    .shadow-shape{width:190px;height:190px;display:block}
    .shadow-shape polygon{
      fill:rgba(15,23,42,.03);
      stroke:rgba(15,23,42,.34);
      stroke-width:2.4;
      stroke-dasharray:8 8;
      vector-effect:non-scaling-stroke;
    }

    .floater{
      position:absolute;width:132px;height:132px;
      cursor:grab;
      user-select:none;
      z-index:5;
    }
    .floater:active{cursor:grabbing}
    .shape-svg{
      width:112px;height:112px;
      filter:drop-shadow(0 10px 18px rgba(15,23,42,.18));
      transform:rotate(var(--rot, 0deg));
      transform-origin:50% 50%;
      transition:transform .08s linear;
      display:block;
      margin:10px auto 0;
    }
    .shape-svg polygon{
      stroke-width:2.6;
      vector-effect:non-scaling-stroke;
    }

    .drift{animation:drift 3.6s ease-in-out infinite alternate}
    @keyframes drift{from{transform:translateY(-10px)}to{transform:translateY(10px)}}

    .rotate-btn{
      position:absolute;
      right:8px;top:8px;
      width:34px;height:34px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.72);
      border:1px solid var(--glass-border);
      color:var(--text-dim);
      cursor:pointer;
      transition:all .15s ease;
      z-index:10;
    }
    .rotate-btn:hover{background:rgba(255,255,255,.88);color:var(--text-main);transform:translateY(-1px)}
    .rotate-btn:active{transform:translateY(0) scale(.98)}

    .toast{
      position:absolute;top:20px;left:50%;transform:translateX(-50%);
      padding:12px 24px;border-radius:99px;
      backdrop-filter:blur(12px);
      font-weight:800;z-index:200;
      border:1px solid var(--glass-border);
      opacity:0;pointer-events:none;
      transition:all .25s ease;
    }
    .toast.show{opacity:1;top:40px}
    .toast.good{background:rgba(16,185,129,.18);color:#047857}
    .toast.bad{background:rgba(244,63,94,.14);color:#be123c}

    .dim{
      position:fixed;inset:0;
      background:rgba(251,246,234,.92);
      backdrop-filter:blur(8px);
      display:none;place-items:center;
      z-index:1000;
    }
    .dim.show{display:grid}
    .modal{
      width:min(450px,90vw);
      background:rgba(255,255,255,.75);
      border:1px solid var(--glass-border);
      border-radius:var(--radius-lg);
      padding:40px;text-align:center;
      box-shadow:0 30px 70px rgba(15,23,42,.15);
    }
    .modal h3{font-size:24px;margin:0 0 10px;color:var(--text-main)}
    .modal p{color:var(--text-dim);line-height:1.7;margin:0 0 28px}

    footer{
      width:min(1200px,94vw);
      margin:40px auto 46px;
    }
    .footer-pill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 18px;
      border-radius:999px;
      background:rgba(255,255,255,.55);
      border:1px solid var(--glass-border);
      box-shadow:0 14px 28px rgba(15,23,42,.08);
      color:var(--text-dim);
      flex-wrap:wrap;
    }
    .footer-left,.footer-right{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:220px;
    }
    .footer-dot{
      width:10px;height:10px;border-radius:50%;
      background:rgba(245,158,11,.75);
      box-shadow:0 0 0 4px rgba(245,158,11,.16);
    }
    .footer-copy{font-size:13px;font-weight:700;color:var(--text-dim)}
    .footer-icon{
      width:28px;height:28px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(56,189,248,.16);
      border:1px solid rgba(56,189,248,.25);
      color:#0284c7;
    }
    .footer-tagline{
      font-size:13px;font-weight:800;color:var(--text-main);
      letter-spacing:.3px;
    }

    .shake{animation:shake .4s ease-in-out}
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-10px)}
      75%{transform:translateX(10px)}
    }

    /* 小提示：按鈕 disabled 狀態（不改整體，只讓「強制輸入」更直覺） */
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      filter:none !important;
    }
  </style>
</head>

<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <div class="brand-badge">
          <img src="JESSIEMATH-Q.png" alt="Logo" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;display:grid;place-items:center;font-weight:900;color:#b45309&quot;>JM</div>';">
        </div>
        <div class="brand-title">Jessie Math</div>
      </div>
      <nav class="nav">
        <a class="pill" href="https://jessiemath0703-chu.github.io/website2/" target="_blank" rel="noopener">
          <i class="fa-solid fa-house"></i> 首頁
        </a>
        <a class="pill" href="https://jessiemath0703-chu.github.io/Game-Lobby/" target="_blank" rel="noopener">
          <i class="fa-solid fa-gamepad"></i> 大廳
        </a>
        <a class="pill accent" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g4-u7" target="_blank" rel="noopener">
          四年級三角形
        </a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- PAGE 1 -->
    <section id="pageStart" class="page active">
      <div class="grid">
        <div class="card">
          <h1 class="h1">影子配對所</h1>
          <p class="sub">把「全等」的圖形送回影子裡。它們會自轉，你的判斷要比它們更快。</p>

          <div class="input-group">
            <div class="input">
              <i class="fa-solid fa-user-astronaut"></i>
              <input id="playerName" maxlength="12" placeholder="輸入探險者姓名（必填）" autocomplete="off" />
            </div>

            <div class="select" title="選擇難度">
              <i class="fa-solid fa-gauge-high"></i>
              <select id="difficulty">
                <option value="basic">基礎（90 秒）</option>
                <option value="hard">困難（60 秒）</option>
                <option value="boss">魔王（45 秒）</option>
              </select>
            </div>

            <!-- ✅ 強制輸入：未填姓名按鈕不可按 -->
            <button id="btnStart" class="btn primary" type="button" disabled>開始探索</button>

            <button id="btnClearLB" class="btn ghost" type="button" title="清除排行">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          </div>

          <!-- ✅ 第一頁說明：遊戲內容 / 計時 / 計分 -->
          <div class="rules">
            <div class="rule">
              <b>遊戲內容</b>
              <ul>
                <li>中間是「影子目標」。周圍會漂浮多個圖形（含三角形、多邊形、星形、箭頭、屋頂等造型）。</li>
                <li>你要把「全等」的那一個拖進影子框，或直接點擊送進去判定。</li>
                <li>周圍圖形會自動旋轉；影子目標不旋轉。</li>
              </ul>
            </div>
            <div class="rule">
              <b>計時方式</b>
              <ul>
                <li>倒數計時結束即結算成績。</li>
                <li>難度越高，時間越短、選項越多、假圖形越像。</li>
              </ul>
            </div>
            <div class="rule">
              <b>計分方式</b>
              <ul>
                <li>選對：依照反應速度加分（越快越高）。</li>
                <li>選錯：連續錯第 1～2 次不扣分；第 3 次起每次選錯開始扣分。</li>
                <li>題目數不設上限：在時間內能對幾個就對幾個。</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <span style="font-weight:700;font-size:18px;">本機排行</span>
            <span class="chip">TOP 10</span>
          </div>
          <table>
            <thead>
              <tr><th>#</th><th>名字</th><th style="text-align:right">積分</th></tr>
            </thead>
            <tbody id="lbBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAGE 2 -->
    <section id="pageGame" class="page">
      <div class="game-shell">
        <div class="hud">
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <div class="chip">USER<span id="hudName">—</span></div>

            <!-- ✅ 不限制幾題：ROUND 變成 MATCH（成功數） -->
            <div class="chip">MATCH<span id="hudRound">0</span></div>

            <div class="chip">TIME<span id="hudTime">0.0</span>s</div>
          </div>

          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <div style="font-weight:800;color:var(--accent-amber);">SCORE <span id="hudScore">0</span></div>
            <button id="btnPause" class="btn ghost" style="padding:8px 16px;font-size:13px;" type="button">暫停</button>
            <button id="btnRestart" class="btn ghost" style="padding:8px 16px;font-size:13px;" type="button">
              <i class="fa-solid fa-rotate-left"></i> 重來
            </button>
            <button id="btnExit" class="btn ghost" style="padding:8px 16px;font-size:13px;" type="button">離開</button>
          </div>
        </div>

        <div id="arena" class="arena">
          <div id="toast" class="toast"></div>

          <div class="center">
            <div id="shadowSlot" class="shadow-slot">
              <svg id="shadowSvg" class="shadow-shape" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet" aria-label="影子圖形">
                <polygon id="shadowPoly"></polygon>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-pill">
      <div class="footer-left">
        <div class="footer-dot" aria-hidden="true"></div>
        <div class="footer-copy">© 2025–2026 Jessie Math 捷析老師. All rights reserved.</div>
      </div>
      <div class="footer-right">
        <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
        <div class="footer-tagline">數學不迷路，Jessie 帶你走向理解。</div>
      </div>
    </div>
  </footer>

  <div id="dim" class="dim" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="modalTitle">系統提示</h3>
      <p id="modalDesc"></p>
      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="btnModalPrimary" class="btn primary" type="button">繼續</button>
        <button id="btnModalSecondary" class="btn ghost" type="button">離開</button>
      </div>
    </div>
  </div>

  <script>
    const LS_KEY = "JM_G4_U7_SHADOW_MATCH_LB_ROTATE_V2_UNLIMITED";
    const DIFF_SECONDS = { basic: 90, hard: 60, boss: 45 };

    const el = (id) => document.getElementById(id);

    const pageStart = el("pageStart");
    const pageGame  = el("pageGame");
    const lbBody = el("lbBody");
    const arena = el("arena");
    const toast = el("toast");
    const shadowPoly = el("shadowPoly");
    const shadowSlot = el("shadowSlot");
    const shadowSvg = el("shadowSvg");

    let state = {
      name: "",
      match: 0,
      totalScore: 0,
      roundStartAt: 0,
      timerId: null,
      paused: false,
      ended: false,
      correctSig: "",
      floaters: [],
      totalSeconds: 90,
      gameStartAt: 0,
      animRaf: 0,
      optionCount: 12,
      fakeTightness: 1.0,
      spinSpeedMin: 40,
      spinSpeedMax: 120,
      currentDiff: "basic",
      wrongStreak: 0
    };

    window.addEventListener("error", (ev)=>{
      try{ openModal("咦，卡住了", `偵測到錯誤：${ev.message}`, "home"); }catch{}
    });
    window.addEventListener("unhandledrejection", (ev)=>{
      try{ openModal("咦，卡住了", `Promise 錯誤：${ev.reason?.message || ev.reason}`, "home"); }catch{}
    });

    function showPage(which){
      pageStart.classList.toggle("active", which === "start");
      pageGame.classList.toggle("active", which === "game");
    }

    function loadLB(){
      try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
      catch { return []; }
    }

    function renderLB(){
      const list = loadLB().sort((a,b)=>b.score-a.score).slice(0,10);
      lbBody.innerHTML = list.length
        ? list.map((r,i)=>`
            <tr>
              <td class="rank">${i+1}</td>
              <td>${escapeHtml(r.name)}</td>
              <td class="score">${r.score}</td>
            </tr>
          `).join("")
        : `<tr><td colspan="3" style="text-align:center;color:var(--text-dim);padding:40px;">尚無紀錄</td></tr>`;
    }

    function flashToast(msg, type){
      toast.textContent = msg;
      toast.className = `toast show ${type}`;
      setTimeout(()=>toast.classList.remove("show"), 1400);
    }

    function openModal(title, desc, mode){
      el("modalTitle").textContent = title;
      el("modalDesc").textContent  = desc;
      el("dim").classList.add("show");

      el("btnModalPrimary").onclick = ()=>{
        el("dim").classList.remove("show");
        if(mode === "pause"){ state.paused = false; }
        else exitToHome();
      };

      el("btnModalSecondary").onclick = ()=>{
        el("dim").classList.remove("show");
        exitToHome();
      };
    }

    function exitToHome(){
      clearInterval(state.timerId);
      stopAutoRotate();
      clearFloaters();
      showPage("start");
      renderLB();
    }

    function clearFloaters(){
      state.floaters.forEach(n => n.remove());
      state.floaters = [];
    }

    /* ========= 全等判定（允許旋轉與翻轉） ========= */
    function canonicalSig(pts){
      const n = pts.length;
      const cx = pts.reduce((s,p)=>s+p[0],0)/n;
      const cy = pts.reduce((s,p)=>s+p[1],0)/n;

      const c = pts.map(([x,y])=>[(x-cx), (y-cy)]).map(([dx,dy])=>[
        Number(dx.toFixed(1)),
        Number(dy.toFixed(1))
      ]);

      const seqStr = (arr)=>arr.map(([dx,dy])=>`${dx},${dy}`).join("|");

      const rotations = (arr)=>{
        const out=[];
        for(let k=0;k<arr.length;k++){
          const r = arr.slice(k).concat(arr.slice(0,k));
          out.push(seqStr(r));
        }
        return out;
      };

      const forward = rotations(c);
      const backward = rotations(c.slice().reverse());
      const all = forward.concat(backward);
      all.sort();
      return all[0];
    }

    /* ========= 形狀種類（變化更多） ========= */
    function pickKind(r){
      const x = r();

      // 三角形 / 四邊形 / 五邊形 / 六邊形 / 屋頂 / 星形 / 箭頭
      if(x < 0.13) return { kind:"tri", sides:3 };
      if(x < 0.36) return { kind:"quad", sides:4 };
      if(x < 0.58) return { kind:"penta", sides:5 };
      if(x < 0.74) return { kind:"hexa", sides:6 };
      if(x < 0.84) return { kind:"house", sides:5 };
      if(x < 0.93) return { kind:"star", sides:10 };
      return { kind:"arrow", sides:7 };
    }

    function makeBaseShape(seed){
      const r = mulberry32((seed*1e9)>>>0);
      const choice = pickKind(r);

      const cx=50, cy=52;
      let pts=[];

      if(choice.kind==="house"){
        const w = 52 + Math.floor(r()*18);
        const h = 44 + Math.floor(r()*16);
        const roof = 18 + Math.floor(r()*12);
        const shift = -12 + Math.floor(r()*25);

        const left = clamp(cx-w/2, 8, 92);
        const right= clamp(cx+w/2, 8, 92);
        const bottom=clamp(cy+h/2, 24, 92);
        const top=clamp(cy-h/2, 10, 70);
        const apexX=clamp(cx+shift, 10, 90);
        const apexY=clamp(top-roof, 6, 60);

        pts=[
          [left,bottom],
          [right,bottom],
          [right,top],
          [apexX,apexY],
          [left,top]
        ];
      }
      else if(choice.kind==="star"){
        // 五角星（10 點）：外半徑 / 內半徑
        const outer = 30 + Math.floor(r()*10);
        const inner = 14 + Math.floor(r()*7);
        const start = r()*Math.PI*2;
        for(let i=0;i<10;i++){
          const ang = start + (i/10)*Math.PI*2;
          const rad = (i%2===0) ? outer : inner;
          const x = clamp(Math.round(cx + Math.cos(ang)*rad), 6, 94);
          const y = clamp(Math.round(cy + Math.sin(ang)*rad), 6, 94);
          pts.push([x,y]);
        }
      }
      else if(choice.kind==="arrow"){
        // 箭頭 7 點（有點像小圖示的感覺）
        const w = 52 + Math.floor(r()*16);
        const h = 40 + Math.floor(r()*14);
        const head = 18 + Math.floor(r()*10);
        const shaft = 14 + Math.floor(r()*8);

        const left = clamp(cx - w/2, 6, 94);
        const right = clamp(cx + w/2, 6, 94);
        const top = clamp(cy - h/2, 6, 80);
        const bottom = clamp(cy + h/2, 20, 94);

        const midY = (top+bottom)/2;
        const headX = right;
        const neckX = clamp(right - head, 10, 92);
        const shaftTop = clamp(midY - shaft, 8, 90);
        const shaftBot = clamp(midY + shaft, 10, 94);

        pts = [
          [left, shaftTop],
          [neckX, shaftTop],
          [neckX, top],
          [headX, midY],
          [neckX, bottom],
          [neckX, shaftBot],
          [left, shaftBot]
        ].map(([x,y])=>[clamp(Math.round(x),6,94), clamp(Math.round(y),6,94)]);
      }
      else{
        // 一般多邊形
        const sides = choice.sides;
        const baseR = 28 + Math.floor(r()*10);
        const jitter = 6 + r()*7;
        const start = r()*Math.PI*2;

        for(let i=0;i<sides;i++){
          const a = start + (i/sides)*Math.PI*2 + (r()*0.30-0.15);
          const rr = baseR + (r()*2-1)*jitter;
          const x = clamp(Math.round(cx+Math.cos(a)*rr), 6, 94);
          const y = clamp(Math.round(cy+Math.sin(a)*rr), 6, 94);
          pts.push([x,y]);
        }
        if(polygonArea2(pts) < 760){
          pts = pts.map(([x,y],i)=>[
            clamp(x + (i%2? 7:-7), 6, 94),
            clamp(y + (i%3? -7:7), 6, 94),
          ]);
        }
      }

      return {
        pts,
        pointsStr: pts.map(p=>p.join(",")).join(" "),
        sig: canonicalSig(pts)
      };
    }

    function makeFakeFrom(basePts, level, tightness){
      const r = mulberry32(hash32("fake:"+canonicalSig(basePts)+":"+level+":"+tightness));
      const pts = basePts.map(p=>[p[0],p[1]]);

      const gx = pts.reduce((s,p)=>s+p[0],0)/pts.length;
      const gy = pts.reduce((s,p)=>s+p[1],0)/pts.length;

      const s = (0.10 + level*0.010) / Math.max(1, tightness);
      const sx = 1 + (r()*2-1)*s;
      const sy = 1 + (r()*2-1)*s;

      const bump = (r()*2-1) * (6 + level*0.4) / Math.max(1, tightness);
      const twist= (r()*2-1) * (6 + level*0.35) / Math.max(1, tightness);

      const out = pts.map(([x,y],i)=>{
        let nx = gx + (x-gx) * (i%2===0 ? sx : 1/sx);
        let ny = gy + (y-gy) * (i%3===0 ? sy : 1/sy);
        nx += (i===0 ? bump : i===1 ? -bump : twist*0.22);
        ny += (i===2 ? -twist : twist*0.14);
        return [clamp(Math.round(nx), 6, 94), clamp(Math.round(ny), 6, 94)];
      });

      if(polygonArea2(out) < 640){
        out[0][0] = clamp(out[0][0] + (r()>0.5? 10:-10), 6, 94);
        out[0][1] = clamp(out[0][1] + (r()>0.5? 8:-8), 6, 94);
      }

      return {
        pts: out,
        pointsStr: out.map(p=>p.join(",")).join(" "),
        sig: canonicalSig(out)
      };
    }

    function paletteByVariant(v){
      switch(String(v)){
        case "1": return { fill:"rgba(56,189,248,.26)",  stroke:"#38bdf8" };
        case "2": return { fill:"rgba(129,140,248,.26)", stroke:"#818cf8" };
        case "3": return { fill:"rgba(245,158,11,.26)",  stroke:"#f59e0b" };
        case "4": return { fill:"rgba(16,185,129,.24)",  stroke:"#10b981" };
        default:  return { fill:"rgba(244,63,94,.22)",   stroke:"#f43f5e" };
      }
    }

    function applyDifficulty(diff){
      state.currentDiff = diff;

      if(diff === "basic"){
        state.optionCount = 10;
        state.fakeTightness = 1.0;
        state.spinSpeedMin = 35;
        state.spinSpeedMax = 90;
      } else if(diff === "hard"){
        state.optionCount = 12;
        state.fakeTightness = 1.35;
        state.spinSpeedMin = 55;
        state.spinSpeedMax = 130;
      } else {
        state.optionCount = 14;
        state.fakeTightness = 1.65;
        state.spinSpeedMin = 75;
        state.spinSpeedMax = 170;
      }
    }

    /* ========= 生成一題（不限制題數：每答對就下一題，直到時間到） ========= */
    function setupRound(){
      clearFloaters();
      state.paused = false;

      el("hudRound").textContent = state.match;
      el("hudScore").textContent = state.totalScore;
      el("hudName").textContent  = state.name;

      const base = makeBaseShape(Math.random());
      state.correctSig = base.sig;

      // 影子不旋轉
      shadowSvg.style.transformOrigin = "50% 50%";
      shadowSvg.style.transform = "rotate(0deg)";

      shadowPoly.setAttribute("points", base.pointsStr);
      shadowPoly.setAttribute("style",
        "fill:rgba(15,23,42,.04);stroke:rgba(15,23,42,.38);stroke-width:2.6;stroke-dasharray:8 8;vector-effect:non-scaling-stroke;"
      );

      const items = [];
      items.push({ pointsStr: base.pointsStr, sig: base.sig, correct:true });

      const targetCount = state.optionCount;
      let guard = 0;
      while(items.length < targetCount && guard < 1200){
        guard++;
        const lvl = 6 + Math.floor(Math.random()*9);
        const fake = makeFakeFrom(base.pts, lvl, state.fakeTightness);
        if(fake.sig === base.sig) continue;
        items.push({ pointsStr: fake.pointsStr, sig: fake.sig, correct:false });
      }
      while(items.length < targetCount){
        const lvl = 10 + Math.floor(Math.random()*10);
        const fake = makeFakeFrom(base.pts, lvl, 1.0);
        if(fake.sig !== base.sig) items.push({ pointsStr: fake.pointsStr, sig: fake.sig, correct:false });
      }

      shuffle(items);

      const w = arena.clientWidth;
      const h = arena.clientHeight;
      const cx = w/2, cy = h/2;
      const rx = Math.min(cx, cy) * 0.78;

      items.forEach((it, idx)=>{
        const node = document.createElement("div");
        node.className = "floater drift";
        node.dataset.sig = it.sig;
        node._dragged = false;

        const dir = (Math.random() > 0.5) ? 1 : -1;
        const spd = lerp(state.spinSpeedMin, state.spinSpeedMax, Math.random()) * dir;
        node.dataset.spin = String(spd);
        node.dataset.rot = String(Math.random()*360);

        const { fill, stroke } = paletteByVariant(idx%5+1);

        node.innerHTML = `
          <div class="rotate-btn" title="手動 +30°（可用可不用）" aria-label="旋轉">
            <i class="fa-solid fa-rotate-right"></i>
          </div>
          <svg class="shape-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
            <polygon points="${it.pointsStr}"
              style="fill:${fill};stroke:${stroke};stroke-width:2.8;vector-effect:non-scaling-stroke;"></polygon>
          </svg>
        `;

        const rbtn = node.querySelector(".rotate-btn");
        rbtn.addEventListener("pointerdown", (e)=>{ e.stopPropagation(); });
        rbtn.addEventListener("click", (e)=>{
          e.stopPropagation();
          if(state.paused || state.ended) return;
          node.dataset.rot = String((parseFloat(node.dataset.rot||"0")+30)%360);
          applyNodeRotation(node);
          flashToast("你轉它，它也轉你（懂）。", "good");
        });

        node.addEventListener("pointerdown", (e)=>onDragStart(e,node));
        node.addEventListener("click", ()=>{
          if(state.paused || state.ended) return;
          if(node._dragged) return;
          snapIntoSlotAndJudge(node);
        });

        const ang = (idx/items.length) * Math.PI * 2;
        node.style.left = (cx + Math.cos(ang)*rx - 66) + "px";
        node.style.top  = (cy + Math.sin(ang)*rx*0.84 - 66) + "px";

        arena.appendChild(node);
        state.floaters.push(node);
        applyNodeRotation(node);
      });

      state.roundStartAt = performance.now();
    }

    function applyNodeRotation(node){
      const rot = parseFloat(node.dataset.rot || "0");
      node.style.setProperty("--rot", rot + "deg");
    }

    function startAutoRotate(){
      stopAutoRotate();
      let last = performance.now();

      const tick = (now)=>{
        state.animRaf = requestAnimationFrame(tick);
        if(state.paused || state.ended) { last = now; return; }

        const dt = Math.min(0.05, (now - last)/1000);
        last = now;

        for(const node of state.floaters){
          if(!node || node.style.pointerEvents === "none") continue;
          const spin = parseFloat(node.dataset.spin || "60");
          let rot = parseFloat(node.dataset.rot || "0");
          rot = (rot + spin*dt) % 360;
          if(rot < 0) rot += 360;
          node.dataset.rot = String(rot);
          applyNodeRotation(node);
        }
      };

      state.animRaf = requestAnimationFrame(tick);
    }

    function stopAutoRotate(){
      if(state.animRaf) cancelAnimationFrame(state.animRaf);
      state.animRaf = 0;
    }

    function onDragStart(e, node){
      if(state.paused || state.ended) return;
      if(e.target && e.target.closest && e.target.closest(".rotate-btn")) return;

      node._dragged = false;

      const arenaRect = arena.getBoundingClientRect();
      const rect = node.getBoundingClientRect();
      const ox = e.clientX - rect.left;
      const oy = e.clientY - rect.top;

      const startL = parseFloat(node.style.left || "0");
      const startT = parseFloat(node.style.top  || "0");

      try { node.setPointerCapture(e.pointerId); } catch {}

      const move = (me)=>{
        node._dragged = true;
        node.style.left = (me.clientX - arenaRect.left - ox) + "px";
        node.style.top  = (me.clientY - arenaRect.top  - oy) + "px";
      };

      const up = (ue)=>{
        node.removeEventListener("pointermove", move);

        const sr = shadowSlot.getBoundingClientRect();
        const nr = node.getBoundingClientRect();
        const inSlot =
          (nr.left + 66 > sr.left && nr.left + 66 < sr.right &&
           nr.top  + 66 > sr.top  && nr.top  + 66 < sr.bottom);

        if(inSlot){
          judge(node, { l:startL, t:startT });
        } else {
          node.style.left = startL + "px";
          node.style.top  = startT + "px";
        }

        try { node.releasePointerCapture(ue.pointerId); } catch {}
        setTimeout(()=> node._dragged = false, 140);
      };

      node.addEventListener("pointermove", move);
      node.addEventListener("pointerup", up, { once:true });
      node.addEventListener("pointercancel", up, { once:true });
    }

    function snapIntoSlotAndJudge(node){
      const sr = shadowSlot.getBoundingClientRect();
      const arenaRect = arena.getBoundingClientRect();
      node.style.left = (sr.left - arenaRect.left + sr.width/2 - 66) + "px";
      node.style.top  = (sr.top  - arenaRect.top  + sr.height/2 - 66) + "px";
      judge(node);
    }

    function judge(node, origin){
      if(state.paused || state.ended) return;

      const sig = node.dataset.sig || "";
      const isSame = (sig === state.correctSig);

      if(isSame){
        state.wrongStreak = 0;

        const sr = shadowSlot.getBoundingClientRect();
        const arenaRect = arena.getBoundingClientRect();
        node.style.left = (sr.left - arenaRect.left + sr.width/2 - 66) + "px";
        node.style.top  = (sr.top  - arenaRect.top  + sr.height/2 - 66) + "px";
        node.classList.remove("drift");
        node.style.pointerEvents = "none";

        handleCorrect();
      } else {
        node.classList.add("shake");
        setTimeout(()=>node.classList.remove("shake"), 400);

        if(origin){
          node.style.left = origin.l + "px";
          node.style.top  = origin.t + "px";
        }

        state.wrongStreak += 1;

        if(state.wrongStreak <= 2){
          flashToast(`選錯（第 ${state.wrongStreak} 次）先不扣分`, "bad");
        } else {
          applyPenalty(10);
          flashToast("選錯開始扣分（連錯已超過 2 次）", "bad");
        }
      }
    }

    function handleCorrect(){
      const sec = (performance.now() - state.roundStartAt)/1000;

      // ✅ 不限制題數：加分後立刻換新題（直到時間到）
      const score = Math.max(10, Math.round(140 - sec*10));
      state.totalScore += score;
      state.match += 1;

      el("hudScore").textContent = state.totalScore;
      el("hudRound").textContent = state.match;

      flashToast(`全等命中！+${score}`, "good");

      setTimeout(()=>{
        if(!state.ended) setupRound();
      }, 520);
    }

    function applyPenalty(p){
      state.totalScore = Math.max(0, state.totalScore - p);
      el("hudScore").textContent = state.totalScore;
    }

    function startCountdown(){
      clearInterval(state.timerId);
      state.timerId = setInterval(()=>{
        if(state.paused || state.ended) return;

        const elapsed = (performance.now() - state.gameStartAt)/1000;
        const remain = Math.max(0, state.totalSeconds - elapsed);
        el("hudTime").textContent = remain.toFixed(1);

        if(remain <= 0){
          timeUp();
        }
      }, 100);
    }

    function timeUp(){
      if(state.ended) return;
      state.ended = true;
      clearInterval(state.timerId);
      flashToast("時間到！", "bad");
      setTimeout(()=> endGame(true), 450);
    }

    function endGame(fromTimeout){
      state.ended = true;
      clearInterval(state.timerId);
      stopAutoRotate();

      const list = loadLB();
      list.push({ name: state.name, score: state.totalScore });
      localStorage.setItem(LS_KEY, JSON.stringify(list));
      renderLB();

      openModal(fromTimeout ? "時間到" : "探索完成", `最終積分：${state.totalScore}`, "home");
    }

    function startGameSafe(){
      showPage("game");

      const waitArenaReady = (tries = 0)=>{
        const w = arena.clientWidth;
        const h = arena.clientHeight;
        if(w > 0 && h > 0){
          setupRound();
          startAutoRotate();
          startCountdown();
          return;
        }
        if(tries > 240){
          setupRound();
          startAutoRotate();
          startCountdown();
          return;
        }
        requestAnimationFrame(()=>waitArenaReady(tries+1));
      };

      requestAnimationFrame(()=>waitArenaReady(0));
    }

    function restartGame(){
      if(state.ended) return;

      state.match = 0;
      state.totalScore = 0;
      el("hudScore").textContent = "0";
      el("hudRound").textContent = "0";

      state.totalSeconds = DIFF_SECONDS[state.currentDiff] ?? 90;
      state.gameStartAt = performance.now();
      el("hudTime").textContent = state.totalSeconds.toFixed(1);

      state.ended = false;
      state.paused = false;
      state.wrongStreak = 0;

      setupRound();
      flashToast("重來！把全等抓出來。", "good");
    }

    function clamp(n,a,b){ return Math.min(b, Math.max(a, n)); }
    function lerp(a,b,t){ return a + (b-a)*t; }

    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
    }

    function mulberry32(a){
      return function(){
        let t=a+=0x6D2B79F5;
        t=Math.imul(t^(t>>>15),t|1);
        t^=t+Math.imul(t^(t>>>7),t|61);
        return ((t^(t>>>14))>>>0)/4294967296;
      };
    }

    function hash32(s){
      let h=2166136261;
      for(let i=0;i<s.length;i++){
        h^=s.charCodeAt(i);
        h=Math.imul(h,16777619);
      }
      return h>>>0;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(m){
        return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m];
      });
    }

    function polygonArea2(pts){
      let sum = 0;
      for(let i=0;i<pts.length;i++){
        const [x1,y1] = pts[i];
        const [x2,y2] = pts[(i+1)%pts.length];
        sum += (x1*y2 - y1*x2);
      }
      return Math.abs(sum);
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderLB();

      const nameInput = el("playerName");
      const startBtn = el("btnStart");

      // ✅ 強制輸入：即時啟用/停用按鈕
      const syncStartEnabled = ()=>{
        const ok = nameInput.value.trim().length > 0;
        startBtn.disabled = !ok;
      };
      nameInput.addEventListener("input", syncStartEnabled);
      syncStartEnabled();

      nameInput.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" && !startBtn.disabled) startBtn.click();
      });

      startBtn.addEventListener("click", ()=>{
        const n = nameInput.value.trim();
        if(!n){ flashToast("請輸入姓名", "bad"); return; }

        state.name = n;

        state.match = 0;
        state.totalScore = 0;
        el("hudScore").textContent = "0";
        el("hudRound").textContent = "0";
        el("hudName").textContent = state.name;

        const diff = el("difficulty").value;
        applyDifficulty(diff);
        state.totalSeconds = DIFF_SECONDS[diff] ?? 90;

        state.gameStartAt = performance.now();
        el("hudTime").textContent = state.totalSeconds.toFixed(1);

        state.ended = false;
        state.paused = false;
        state.wrongStreak = 0;

        startGameSafe();
      });

      el("btnClearLB").addEventListener("click", ()=>{
        localStorage.removeItem(LS_KEY);
        renderLB();
        flashToast("已清除排行", "good");
      });

      el("btnPause").addEventListener("click", ()=>{
        if(state.ended) return;
        state.paused = true;
        openModal("已暫停", "休息一下，回來再抓那個全等。", "pause");
      });

      el("btnRestart").addEventListener("click", ()=>{
        if(state.ended) return;
        restartGame();
      });

      el("btnExit").addEventListener("click", ()=>{
        openModal("確定離開？", "目前的進度將不會被儲存。", "exit");
      });
    });
  </script>
</body>
</html>
